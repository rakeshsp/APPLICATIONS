<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ðŸ¦µ MRI Knee Reporting Tool â€” Full Version</title>

  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --muted:#94a3b8;
      --accent:#3b82f6;
      --accent-2:#06b6d4;
      --radius:12px;
      font-family: Inter, system-ui, sans-serif;
    }

    body{
      margin:0;
      background:linear-gradient(180deg,var(--bg), #071124 80%);
      color:#e6eef8;
      padding:28px;
    }

    .container{
      max-width:1100px;
      margin:auto;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border-radius:16px;
      padding:22px;
      border:1px solid rgba(255,255,255,0.05);
    }

    h1{margin:0;font-size:20px}
    .subtitle{color:var(--muted); font-size:13px}

    /* Tabs */
    .tabs{display:flex; gap:8px; background:rgba(255,255,255,0.03); padding:8px; border-radius:12px; width:fit-content}
    .tab{
      padding:8px 14px; border-radius:10px; cursor:pointer;
      color:var(--muted); font-weight:600; border:1px solid transparent;
    }
    .tab.active{
      background:linear-gradient(90deg,var(--accent), var(--accent-2));
      color:white; box-shadow:0 4px 20px rgba(59,130,246,0.2);
    }

    /* Layout */
    .grid{display:grid; grid-template-columns:1fr 420px; gap:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr;}}

    .panel{background:var(--panel); padding:14px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.05)}
    .section{background:rgba(255,255,255,0.02); padding:10px; border-radius:10px; margin-bottom:12px}

    .collapsible-title{
      display:flex; justify-content:space-between; cursor:pointer;
      padding:8px; border-radius:8px; background:rgba(255,255,255,0.04);
    }

    textarea, input, select{
      width:100%; background:transparent; border:1px solid rgba(255,255,255,0.1);
      padding:8px; border-radius:8px; color:white;
    }

    textarea.report{min-height:260px; resize:vertical; font-family:monospace}

    ul{padding-left:18px; margin:8px 0; color:var(--muted); font-size:14px}

    .row{display:flex; gap:8px}

    .btn{
      padding:10px 12px; border-radius:10px; border:none; cursor:pointer;
      background:var(--accent); color:white; font-weight:600;
    }
    .btn.secondary{background:transparent; border:1px solid rgba(255,255,255,0.2); color:var(--muted)}

    .badge{background:rgba(255,255,255,0.08); padding:6px 12px; border-radius:20px; font-size:12px}
    .muted{color:var(--muted)}
  </style>
</head>

<body>
<div class="container">

  <header style="margin-bottom:20px">
    <h1>ðŸ¦µ MRI Knee AI-Assisted Reporting</h1>
    <div class="subtitle">Structured reporting â€¢ Detailed anatomy â€¢ Auto-generated report</div>
  </header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-region="Right">Right Knee</button>
    <button class="tab" data-region="Left">Left Knee</button>
    <button class="tab" data-region="Bilateral">Bilateral</button>
  </div>

  <div class="grid">

    <!-- LEFT SIDE -->
    <div class="panel">

      <!-- Study Context -->
      <div class="section">
        <div class="collapsible-title" data-toggle="ctx"><strong>Study Context</strong></div>
        <div id="ctx" style="padding:10px">

          <div class="row">
            <input id="patientName" placeholder="Patient Name">
            <input id="patientId" placeholder="Patient ID">
          </div>

          <div class="row" style="margin-top:8px">
            <input id="patientAge" placeholder="Age">
            <input id="patientSex" placeholder="Sex (M/F)">
            <input id="studyDate" type="date">
          </div>

          <input id="refPhys" placeholder="Referring Physician" style="margin-top:8px">

        </div>
      </div>

      <!-- Technique -->
      <div class="section">
        <div class="collapsible-title" data-toggle="tech"><strong>Technique Details</strong></div>
        <div id="tech" style="display:none; padding:10px">
          <ul>
            <li>3T MRI scanner using dedicated knee coil.</li>
            <li>Sagittal PD, PD FS; Coronal PD FS, T1; Axial PD FS.</li>
            <li>Optional GRE/DESS/STIR/3D SPACE.</li>
            <li>Slice thickness â‰¤3 mm.</li>
          </ul>
        </div>
      </div>

      <!-- ANATOMY -->
      <div class="section">
        <div class="collapsible-title" data-toggle="anat"><strong>Systematic Anatomical Assessment</strong></div>
        <div id="anat" style="display:none; padding:10px">
          <div id="anatomySections"></div>

          <div class="row" style="margin-top:12px">
            <button class="btn secondary" id="clearChecklist">Reset Checklist</button>
            <button class="btn" id="autoFillDemo">Auto-fill Demo</button>
          </div>
        </div>
      </div>

      <!-- Impression -->
      <div class="section">
        <div class="collapsible-title" data-toggle="impr"><strong>AI Impression (Optional)</strong></div>
        <div id="impr" style="display:none; padding:10px">
          <textarea id="impression" rows="5" placeholder="Write or auto-generate impression..."></textarea>
        </div>
      </div>

    </div>

    <!-- RIGHT SIDE -->
    <div class="panel">

      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3>Generated Report</h3>
        <span id="regionBadge" class="badge">Right</span>
      </div>

      <div class="row" style="margin:10px 0">
        <button class="btn" id="generateBtn">Generate Report</button>
        <button class="btn secondary" id="copyReport">Copy</button>
        <button class="btn secondary" id="downloadReport">Download</button>
      </div>

      <textarea id="reportArea" class="report" placeholder="Report will appear here..."></textarea>

      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="clearAll">Clear All</button>
        <button class="btn" id="finalizeBtn">Copy Impression</button>
      </div>

    </div>

  </div>

</div>

<script>
/* ------------------------- ANATOMICAL DEFINITIONS ------------------------ */

const anatomySections = [
  {
    key:'bone',
    title:'Bone & Marrow',
    bullets:[
      'Assess for bone contusions or marrow edema.',
      'Check for fractures or subcortical cysts.',
      'Evaluate subchondral marrow for insufficiency injury.',
      'Look for cortical irregularities.'
    ]
  },
  {
    key:'cartilage',
    title:'Articular Cartilage',
    bullets:[
      'Evaluate medial, lateral, and patellofemoral compartments.',
      'Grade lesions (Outerbridge Iâ€“IV).',
      'Identify delamination or full-thickness defects.',
      'Assess subchondral marrow reaction.'
    ]
  },
  {
    key:'menisci',
    title:'Menisci',
    bullets:[
      'Identify surface-reaching tears.',
      'Determine tear morphology (horizontal/vertical/radial).',
      'Assess posterior horn & root attachments.',
      'Look for meniscal extrusion.'
    ]
  },
  {
    key:'ligaments',
    title:'Ligaments',
    bullets:[
      'ACL: assess continuity and edema patterns.',
      'PCL: evaluate thickness and fiber integrity.',
      'MCL/LCL: grade sprains.',
      'Assess posterolateral corner.'
    ]
  },
  {
    key:'extensor',
    title:'Extensor Mechanism',
    bullets:[
      'Quadriceps & patellar tendons: tears/tendinosis.',
      'Patellar tilt, height, tracking.',
      'Evaluate retinacula & MPFL.'
    ]
  },
  {
    key:'effusion',
    title:'Joint Effusion & Synovium',
    bullets:[
      'Estimate effusion volume.',
      'Identify synovitis.',
      'Assess Bakerâ€™s cyst.',
      'Identify loose bodies.'
    ]
  },
  {
    key:'soft',
    title:'Soft Tissues',
    bullets:[
      'Identify soft tissue edema.',
      'Evaluate Hoffaâ€™s fat pad.',
      'Examine neurovascular bundle.',
      'Check bursae & cysts.'
    ]
  }
];

const checklistState = {};

function buildAnatomyUI(){
  const container = document.getElementById("anatomySections");
  container.innerHTML = "";

  anatomySections.forEach(sec => {
    checklistState[sec.key] = {finding:"not-assessed", note:""};

    const block = document.createElement("div");
    block.className = "section";
    block.innerHTML = `
      <div class="collapsible-title" data-anat="${sec.key}">
        <strong>${sec.title}</strong>
        <span class="muted">Expand</span>
      </div>

      <div id="anat-${sec.key}" style="display:none; padding:10px">
        <ul>${sec.bullets.map(b=>`<li>${b}</li>`).join("")}</ul>

        <div class="row">
          <select data-key="${sec.key}">
            <option value="normal">Normal</option>
            <option value="abnormal">Abnormal</option>
            <option value="not-assessed" selected>Not Assessed</option>
          </select>

          <input data-note="${sec.key}" placeholder="Optional notes...">
        </div>
      </div>
    `;
    container.appendChild(block);
  });

  /* Collapsible toggles */
  document.querySelectorAll("[data-anat]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const el = document.getElementById("anat-"+btn.dataset.anat);
      el.style.display = (el.style.display==="none")?"block":"none";
    });
  });

  /* Track changes */
  container.addEventListener("change", e=>{
    if(e.target.matches("select")){
      const k = e.target.dataset.key;
      checklistState[k].finding = e.target.value;
    }
  });
  container.addEventListener("input", e=>{
    if(e.target.matches("input[data-note]")){
      checklistState[e.target.dataset.note].note = e.target.value;
    }
  });
}

buildAnatomyUI();

/* ------------------------- COLLAPSIBLE GLOBAL SECTIONS ------------------------ */
document.querySelectorAll("[data-toggle]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const id = btn.getAttribute("data-toggle");
    const el = document.getElementById(id);
    el.style.display = (el.style.display==="none")?"block":"none";
  });
});

/* ------------------------- REGION TABS ------------------------ */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById("regionBadge").textContent = tab.dataset.region;
  });
});

/* ------------------------- REPORT GENERATION ------------------------ */

function buildReport(){
  const region = document.querySelector(".tab.active").dataset.region;

  const patient = {
    name: patientName.value || "â€”",
    id: patientId.value || "â€”",
    age: patientAge.value || "â€”",
    sex: patientSex.value || "â€”",
    date: studyDate.value || new Date().toISOString().slice(0,10),
    ref: refPhys.value || "â€”"
  };

  const technique =
`Technique:
- 3T MRI knee protocol.
- Sagittal PD / PD FS; Coronal PD FS / T1; Axial PD FS.
- Slice thickness â‰¤3 mm.`;

  const findings = [];
  anatomySections.forEach(s=>{
    const item = checklistState[s.key];
    if(item.finding==="not-assessed") return;
    findings.push(`- ${s.title}: ${item.finding==="normal"?"Normal":"Abnormal"}${item.note?(" â€” "+item.note):"."}`);
  });
  if(findings.length===0) findings.push("- No documented findings.");

  const impressionText = impression.value.trim() || "No acute osseous or ligamentous abnormality.";

  return (
`MRI Knee Report â€” ${region}

Patient:
- Name: ${patient.name}
- ID: ${patient.id}
- Age/Sex: ${patient.age} / ${patient.sex}
- Date: ${patient.date}
- Referring Physician: ${patient.ref}

${technique}

Systematic Assessment:
${findings.join("\n")}

Impression:
${impressionText}
`);
}

/* Buttons */
generateBtn.addEventListener("click", ()=>{
  reportArea.value = buildReport();
});

copyReport.addEventListener("click", ()=>{
  navigator.clipboard.writeText(reportArea.value);
  alert("Copied to clipboard.");
});

downloadReport.addEventListener("click", ()=>{
  const blob = new Blob([reportArea.value], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "knee_mri_report.txt";
  a.click();
});

clearAll.addEventListener("click", ()=>{
  if(!confirm("Clear all fields?")) return;
  document.querySelectorAll("input, textarea").forEach(e=>e.value="");
  document.querySelectorAll("#anatomySections select").forEach(s=>s.value="not-assessed");
  Object.keys(checklistState).forEach(k=>{
    checklistState[k]={finding:"not-assessed", note:""};
  });
});

finalizeBtn.addEventListener("click", ()=>{
  const imp = impression.value.trim();
  navigator.clipboard.writeText(imp);
  alert("Impression copied:\n\n"+imp);
});

/* ------------------------- DEMO BUTTON ------------------------ */
autoFillDemo.addEventListener("click", ()=>{
  patientName.value = "Jane Doe";
  patientId.value = "MRN-44321";
  patientAge.value = "34";
  patientSex.value = "F";
  studyDate.value = new Date().toISOString().slice(0,10);
  refPhys.value = "Dr. Smith";

  checklistState.ligaments.finding = "abnormal";
  document.querySelector('select[data-key="ligaments"]').value="abnormal";
  document.querySelector('input[data-note="ligaments"]').value="ACL tear";
});

clearChecklist.addEventListener("click", ()=>{
  document.querySelectorAll("#anatomySections select").forEach(s=>s.value="not-assessed");
  document.querySelectorAll("#anatomySections input").forEach(i=>i.value="");
  Object.keys(checklistState).forEach(k=>checklistState[k]={finding:"not-assessed",note:""});
});
</script>

</body>
</html>
